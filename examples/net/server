#!/usr/local/bin/sharpl

(if (not (= #ARG 3)) 
  (say "Usage: server [Host] [Port] [Password]")
  (stop))

(var HOST (ARG 0))
(var PORT (parse-int:_ (ARG 1)))
(var PASSWORD (ARG 2))

(var clients (List))
(var s (net/accept (net/listen HOST:PORT)))

(^handle-connect [c]
  (say "New client")
  (push clients c))

(^handle-request [c]
  (say "New request")
  (let [req (c)]
    (say req)))

(loop
  (let [ready (poll s clients*)]
    (else (is s ready) 
      (handle-connect (s))
      (handle-request ready))))